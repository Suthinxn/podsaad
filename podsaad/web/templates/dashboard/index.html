{% extends "/base/default_page.html" %}

{% block title %}PODSAAD - ระบบพยากรณ์คุณภาพอากาศภาคใต้{% endblock title %}

{% block content %}
<div class="flex flex-col min-h-screen">
  <div class="container mx-auto max-w-7xl px-4">

    <!-- Header -->
    <div class="mt-6">
      <div class="flex flex-col sm:flex-row sm:items-center gap-4 mb-4">
        <div class="w-14 h-14 rounded-2xl flex items-center justify-center shadow-lg bg-white border border-gray-100">
          <i class="ph ph-map-trifold text-3xl text-blue-600"></i>
        </div>
        <div>
          <h1 class="text-3xl sm:text-4xl font-bold bg-gradient-to-r from-cyan-500 to-blue-800 bg-clip-text text-transparent">
            ระบบพยากรณ์ PM2.5
          </h1>
          <p class="text-gray-600 mt-1 flex items-center gap-2 text-sm sm:text-base">
            <i class="ph ph-map-pin"></i>
            ข้อมูลคุณภาพอากาศในพื้นที่ภาคใต้ของประเทศไทย
          </p>
        </div>
      </div>
    </div>

    <!-- Cards -->
    <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
      <div class="bg-white rounded-xl shadow-md p-6 border border-gray-100 hover:shadow-xl transition">
        <h3 class="text-gray-600 text-sm font-medium">สถานะปัจจุบัน</h3>
          {% if avg_pm25 is not none %}
              {% set pm25 = avg_pm25 | float %}

              {% if 0 <= pm25 <= 25 %}
                  {% set color_class = "text-green-500" %}
                  {% set level_text = "ดีมาก" %}
              {% elif 26 <= pm25 <= 37 %}
                  {% set color_class = "text-lime-500" %}
                  {% set level_text = "ดี" %}
              {% elif 38 <= pm25 <= 50 %}
                  {% set color_class = "text-yellow-500" %}
                  {% set level_text = "ปานกลาง" %}
              {% elif 51 <= pm25 <= 90 %}
                  {% set color_class = "text-orange-500" %}
                  {% set level_text = "เริ่มมีผล" %}
              {% else %}
                  {% set color_class = "text-red-500" %}
                  {% set level_text = "มีผลต่อสุขภาพ" %}
              {% endif %}

              <p class="text-3xl font-bold {{ color_class }} mt-2">
                  {{ level_text }}
              </p>
              <p class="text-gray-500 text-sm">เฉลี่ย {{ pm25 | round(2) }} µg/m³</p>
          {% else %}
              <p class="text-gray-500 text-sm">ไม่มีข้อมูล</p>
          {% endif %}
      </div>
      <div class="bg-white rounded-xl shadow-md p-6 border border-gray-100 hover:shadow-xl transition">
        <h3 class="text-gray-600 text-sm font-medium">ระยะพยากรณ์</h3>
        <p class="text-3xl font-bold text-blue-600 mt-2">14 วัน</p>
        <p class="text-gray-500 text-sm">อัปเดตข้อมูลทุกวันเวลา 00:00 น.</p>
      </div>
      <div class="bg-white rounded-xl shadow-md p-6 border border-gray-100 hover:shadow-xl transition">
        <h3 class="text-gray-600 text-sm font-medium">พื้นที่ครอบคลุม</h3>
        <p class="text-3xl font-bold text-purple-600 mt-2">14 จังหวัด</p>
        <p class="text-gray-500 text-sm">ภาคใต้ของไทย</p>
      </div>
    </section>


<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 min-h-[80vh]">

  <!-- Sidebar -->
  <div class="flex flex-col space-y-6 h-full">

    <!-- Card: เลือกโมเดล -->
    <div class="bg-white rounded-2xl shadow-lg p-6 border border-gray-100 hover:shadow-xl transition">
      <h2 class="text-lg font-semibold flex items-center gap-2 mb-4 text-gray-800">
        <i class="ph ph-brain text-blue-600 text-2xl"></i>
        เลือกโมเดล
      </h2>
      <div class="flex gap-3 flex-wrap">
        {% for model_name in ['Conv1D+BiLSTM','SARIMAX'] %}
          <a href="{{ url_for('dashboard.index', select_model=model_name) }}"
             class="px-4 py-2 rounded-lg border text-sm font-medium transition-all duration-200
             {% if select_model == model_name %}
               bg-blue-600 text-white border-blue-600 shadow-md
             {% else %}
               bg-white text-gray-700 border-gray-300 hover:bg-blue-50 hover:text-blue-700
             {% endif %}">
            {{ model_name }}
          </a>
        {% endfor %}
      </div>
    </div>

    <!-- Card: เลือกวันที่ -->
    <div class="bg-white rounded-2xl shadow-lg p-6 border border-gray-100 hover:shadow-xl transition">
      <h2 class="text-lg font-semibold flex items-center gap-2 mb-4">
        <i class="ph ph-calendar-minus text-blue-600 text-2xl"></i>
        เลือกวันที่พยากรณ์
      </h2>
      <div class="flex gap-2 overflow-x-auto pb-2 custom-scrollbar">
        {% for day in range(14) %}
          {% set date_label = (today + timedelta(days=day)).strftime('%d %b') %}
          <button
            onclick="changeDay({{ day }})"
            class="px-4 py-2 rounded-lg border text-sm whitespace-nowrap transition
              {% if day == current_day %}
                bg-blue-600 text-white border-blue-600 shadow-md
              {% else %}
                bg-white hover:bg-blue-50 border-gray-300 text-gray-700
              {% endif %}">
            {{ date_label }}
          </button>
        {% endfor %}
      </div>
    </div>

    <!-- Card: ระดับคุณภาพอากาศ -->
    <div class="bg-white rounded-2xl shadow-lg p-6 border border-gray-100 hover:shadow-xl transition flex-grow">
      <h2 class="text-lg font-semibold flex items-center gap-2 mb-4 text-gray-800">
        <i class="ph ph-wind text-green-600 text-2xl"></i>
        ระดับคุณภาพอากาศ
      </h2>
      <div class="space-y-3 text-sm text-gray-700">
        <div class="flex items-center gap-3"><span class="w-6 h-6 bg-blue-400 rounded-md shadow-sm"></span> ดีมาก (0–15)</div>
        <div class="flex items-center gap-3"><span class="w-6 h-6 bg-green-400 rounded-md shadow-sm"></span> ดี (16–25)</div>
        <div class="flex items-center gap-3"><span class="w-6 h-6 bg-yellow-400 rounded-md shadow-sm"></span> ปานกลาง (26–37)</div>
        <div class="flex items-center gap-3"><span class="w-6 h-6 bg-orange-400 rounded-md shadow-sm"></span> เริ่มมีผล (38–50)</div>
        <div class="flex items-center gap-3"><span class="w-6 h-6 bg-red-400 rounded-md shadow-sm"></span> มีผลต่อสุขภาพ (>50)</div>
      </div>
    </div>

  </div>

  <!-- Main Map -->
  <div class="lg:col-span-2 flex flex-col space-y-6">
    <div class="bg-white rounded-2xl shadow-lg p-6 border border-gray-100 hover:shadow-xl transition flex-grow">
      <h2 class="text-lg font-semibold flex items-center gap-2 text-gray-800">
        <i class="ph ph-calendar-check text-blue-600 text-2xl"></i>
        พยากรณ์วันที่ {{ selected_date_label }}
      </h2>
    </div>
    <div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden hover:shadow-xl transition h-fit">
      {{ map_html | safe }}
    </div>
  </div>

</div>


    <!-- Table -->
    <div class="mt-8">

      <div class="mb-4">
        <h1 class="text-xl">
          ข้อมูล PM2.5
        </h1>
        <p class="text-sm text-gray-500 mt-1">อัปเดตล่าสุดเมื่อ {{ latest_date }}</p>
      </div>
        

      <div class="bg-white shadow-xl border border-gray-100 rounded-lg overflow-hidden">
        <div class="overflow-x-auto">
          <table class="table table-zebra w-full text-sm">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-4 text-left">สถานี</th>
                <th class="px-4 py-4 text-center">PM2.5 (µg/m³)</th>
                <th class="px-4 py-4 text-center">PM1 (µg/m³)</th>
                <th class="px-4 py-4 text-center">PM0.1 (µg/m³)</th>
                <th class="px-4 py-4 text-center">
                  <div class="flex items-center justify-center gap-2">
                    <i class="ph ph-thermometer text-xl"></i>
                    อุณหภูมิ (°C)
                  </div>
                </th>
                <th class="px-4 py-4 text-center">
                  <div class="flex items-center justify-center gap-2">
                    <i class="ph ph-drop-simple text-xl"></i>
                    <span>ความชื้น (%)</span>
                  </div>
                </th>
                <th class="px-4 py-4 text-center">
                  <div class="flex items-center justify-center gap-2">
                    <i class="ph ph-info text-xl"></i>
                    <span>รายละเอียด</span>
                  </div>
                </th>
              </tr>
            </thead>

            <tbody>
              {%if models_list %}
                {% for model in models_list %}
                <tr class="hover:bg-blue-50">
                  <td class="px-6 py-4">{{ station_descriptions[model.station_code] }}</td>
                  <!-- PM2.5 -->
                  <td class="text-center">
                    {% if model.PM_2_5 is not none %}
                      {% set pm25 = model.PM_2_5 | float %}
                      
                      {% if 0 <= pm25 <= 25 %}
                        {% set bg_class = "bg-blue-400" %}
                      {% elif 26 <= pm25 <= 37 %}
                        {% set bg_class = "bg-green-400" %}
                      {% elif 38 <= pm25 <= 50 %}
                        {% set bg_class = "bg-yellow-400" %}
                      {% elif 51 <= pm25 <= 90 %}
                        {% set bg_class = "bg-orange-400" %}
                      {% else %}
                        {% set bg_class = "bg-red-400" %}
                      {% endif %}

                      <div class="text-white px-2 py-1 w-1/2 rounded mx-auto {{ bg_class }}">
                        {{ pm25 | round(2) }}
                      </div>
                    {% else %}
                      -
                    {% endif %}
                  </td>
                  <!-- PM1 -->
                  <td class="text-center">
                      {% if model.PM_1 is not none %}
                      {{ "%0.2f" | format(model.PM_1) }}
                      {% else %}
                      -
                      {% endif %}
                  </td>
                  <!-- PM0.1 -->
                  <td class="text-center">
                    {% if model.PM_0_1 is not none %}
                      {{ "%0.2f" | format(model.PM_0_1) }}
                    {% else %}
                      -
                    {% endif %}
                  </td>
                  <!-- temperature -->
                  <td class="text-center">
                    {% if model.temperature %}
                      {{ "%0.2f" | format(model.temperature) }}
                    {% endif %}
                  </td>
                  <!-- humidity -->
                  <td class="text-center">
                    {% if model.humidity %}
                      {{ "%0.2f" | format(model.humidity) }}
                    {% endif %}
                  </td>
                  <td class="text-center">
                      <a class="btn btn-ghost" href="{{ url_for('dashboard.graph_infomation', station=model.station_code) }}">
                        <i class="ph ph-chart-bar text-xl"></i>
                      </a>
                  </td>
                </tr>
                {% endfor %}
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>

      
    </div>

  </div>
</div>
<!-- JavaScript -->
<script>
  function changeDay(day) {
    const url = new URL(window.location.href);
    url.searchParams.set('select_day', day);
    window.location.href = url.toString();
  }
</script>
{% endblock content %}
